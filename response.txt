// src/chatView.ts
import * as vscode from 'vscode';
import { ArpApiClient } from './arp/apiClient';
import { ChatSessionController } from './arp/sessionController';

export class ChatViewProvider implements vscode.WebviewViewProvider {
    private quantumApiUrl = "http://localhost:8000"; // Quantum bot backend
    private arpApi: ArpApiClient;
    private arpController?: ChatSessionController;
    private currentMode: 'quantum' | 'arp' = 'quantum';
    private arpOutput: vscode.OutputChannel;
    private messageIds: Set<string> = new Set();

    constructor(private readonly context: vscode.ExtensionContext) {
        // Initialize ARP API
        const getBaseUrl = () => "http://localhost:8000/api/v1"; // ARP backend
        this.arpOutput = vscode.window.createOutputChannel('ARP Backend');
        this.arpApi = new ArpApiClient(getBaseUrl, this.arpOutput);
        this.context.subscriptions.push(this.arpOutput);
    }

    resolveWebviewView(webviewView: vscode.WebviewView) {
        webviewView.webview.options = {
            enableScripts: true
        };

        webviewView.webview.html = this.getHtml();

        // Handle messages from webview
        webviewView.webview.onDidReceiveMessage(async (message) => {
            try {
                switch (message.command) {
                    case 'switchMode':
                        this.currentMode = message.mode;
                        webviewView.webview.postMessage({
                            command: 'modeSwitched',
                            mode: this.currentMode
                        });
                        if (this.currentMode === 'arp') {
                            await this.initializeArpController(webviewView);
                        }
                        break;

                    case 'sendMessage':
                        if (this.currentMode === 'quantum') {
                            await this.handleQuantumQuery(message.text, webviewView);
                        } else {
                            await this.handleArpQuery(message.text, webviewView);
                        }
                        break;

                    case 'checkBackend':
                        await this.checkBackendHealth(webviewView);
                        break;

                    // ARP action handlers
                    case 'acceptQuestion':
                        if (this.arpController) {
                            await this.arpController.acceptQuestion();
                            // Get updated state and send to webview
                            const state = this.arpController.getState();
                            webviewView.webview.postMessage({
                                command: 'arpState',
                                state: {
                                    status: state.status,
                                    phase: state.phase,
                                    progressPct: state.progressPct,
                                    pendingQuestion: state.pendingQuestion,
                                    pendingAction: state.pendingAction,
                                    lastSuggestedAnswer: state.lastSuggestedAnswer,
                                    experimentId: state.experimentId
                                }
                            });
                        }
                        break;

                    case 'denyQuestion':
                        if (this.arpController && message.value) {
                            await this.arpController.denyQuestionEdit(message.value);
                            const state = this.arpController.getState();
                            webviewView.webview.postMessage({
                                command: 'arpState',
                                state: {
                                    status: state.status,
                                    phase: state.phase,
                                    progressPct: state.progressPct,
                                    pendingQuestion: state.pendingQuestion,
                                    pendingAction: state.pendingAction,
                                    lastSuggestedAnswer: state.lastSuggestedAnswer,
                                    experimentId: state.experimentId
                                }
                            });
                        }
                        break;

                    case 'acceptConfirm':
                        if (this.arpController) {
                            await this.arpController.acceptConfirm();
                            const state = this.arpController.getState();
                            webviewView.webview.postMessage({
                                command: 'arpState',
                                state: {
                                    status: state.status,
                                    phase: state.phase,
                                    progressPct: state.progressPct,
                                    pendingQuestion: state.pendingQuestion,
                                    pendingAction: state.pendingAction,
                                    lastSuggestedAnswer: state.lastSuggestedAnswer,
                                    experimentId: state.experimentId
                                }
                            });
                        }
                        break;

                    case 'denyConfirm':
                        if (this.arpController && message.reason !== undefined) {
                            await this.arpController.denyConfirm(message.reason || "", "");
                            const state = this.arpController.getState();
                            webviewView.webview.postMessage({
                                command: 'arpState',
                                state: {
                                    status: state.status,
                                    phase: state.phase,
                                    progressPct: state.progressPct,
                                    pendingQuestion: state.pendingQuestion,
                                    pendingAction: state.pendingAction,
                                    lastSuggestedAnswer: state.lastSuggestedAnswer,
                                    experimentId: state.experimentId
                                }
                            });
                        }
                        break;

                    case 'newSession':
                        if (this.arpController) {
                            await this.arpController.startFreshSession();
                            this.messageIds.clear();
                            webviewView.webview.postMessage({
                                command: 'clearChat'
                            });
                        }
                        break;
                }
            } catch (err: any) {
                webviewView.webview.postMessage({
                    command: "error",
                    text: err.message || "Unknown error occurred"
                });
            }
        });

        // Check backend health on load
        this.checkBackendHealth(webviewView);
    }

    private async initializeArpController(webviewView: vscode.WebviewView) {
        if (!this.arpController) {
            this.arpController = new ChatSessionController(
                this.arpApi,
                this.context,
                { pollIntervalMs: 3000 }
            );

            // Listen for ARP state updates
            this.arpController.onUpdate((state) => {
                if (this.currentMode === 'arp') {
                    // Send state to webview
                    webviewView.webview.postMessage({
                        command: 'arpState',
                        state: {
                            status: state.status,
                            phase: state.phase,
                            progressPct: state.progressPct,
                            pendingQuestion: state.pendingQuestion,
                            pendingAction: state.pendingAction,
                            lastSuggestedAnswer: state.lastSuggestedAnswer,
                            experimentId: state.experimentId,
                            researchType: state.researchType
                        }
                    });

                    // Send messages with deduplication
                    if (state.messages && state.messages.length > 0) {
                        const lastMessage = state.messages[state.messages.length - 1];
                        const messageId = `${lastMessage.role}-${lastMessage.content.slice(0, 50)}-${lastMessage.createdAt}`;
                        
                        if (!this.messageIds.has(messageId) && lastMessage.role !== "user") {
                            this.messageIds.add(messageId);
                            webviewView.webview.postMessage({
                                command: "arpMessage",
                                message: {
                                    role: lastMessage.role,
                                    content: lastMessage.content,
                                    kind: lastMessage.kind
                                }
                            });

                            // Clean up old message IDs
                            setTimeout(() => this.messageIds.delete(messageId), 5000);
                        }
                    }
                }
            });
        }
    }

    private async checkBackendHealth(webviewView: vscode.WebviewView) {
        try {
            // Check Quantum backend
            let quantumHealth = false;
            try {
                const response = await fetch(`${this.quantumApiUrl}/health`);
                quantumHealth = response.ok;
            } catch {
                quantumHealth = false;
            }
            
            // Check ARP backend
            let arpHealth = false;
            try {
                // Try to get status of a non-existent experiment to check if backend is reachable
                await this.arpApi.getStatus("health-check").catch(() => {});
                arpHealth = true;
            } catch {
                arpHealth = false;
            }

            webviewView.webview.postMessage({
                command: 'backendStatus',
                quantum: quantumHealth,
                arp: arpHealth
            });
        } catch {
            webviewView.webview.postMessage({
                command: 'backendStatus',
                quantum: false,
                arp: false
            });
        }
    }

    private async handleQuantumQuery(query: string, webviewView: vscode.WebviewView) {
        webviewView.webview.postMessage({ command: 'showLoading' });

        try {
            const response = await fetch(`${this.quantumApiUrl}/api/chat/message`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    query: query,
                    detail_level: "intermediate"
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();

            webviewView.webview.postMessage({
                command: "quantumReply",
                text: data.reply || "No response from quantum backend"
            });

        } catch (err: any) {
            webviewView.webview.postMessage({
                command: "error",
                text: `Quantum backend not responding: ${err.message || "Connection failed"}`
            });
        } finally {
            webviewView.webview.postMessage({ command: 'hideLoading' });
        }
    }

    private async handleArpQuery(query: string, webviewView: vscode.WebviewView) {
        if (!this.arpController) {
            await this.initializeArpController(webviewView);
        }

        webviewView.webview.postMessage({ command: 'showLoading' });

        try {
            // Add user message
            webviewView.webview.postMessage({
                command: "userMessage",
                text: query
            });

            // Start ARP session
            await this.arpController!.startFromChatQuery(query, "ai", "");

        } catch (err: any) {
            webviewView.webview.postMessage({
                command: "error",
                text: `ARP Error: ${err.message || "Failed to start session"}`
            });
        } finally {
            webviewView.webview.postMessage({ command: 'hideLoading' });
        }
    }

    private getHtml(): string {
        return `<!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8" />
            <meta name="viewport" content="width=device-width, initial-scale=1.0" />
            <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
            <style>
                * {
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                }

                :root {
                    --bg-primary: #0a0a0f;
                    --bg-secondary: #14141f;
                    --bg-tertiary: #1a1a2a;
                    --accent-quantum: #6366f1;
                    --accent-quantum-glow: rgba(99, 102, 241, 0.3);
                    --accent-arp: #10b981;
                    --accent-arp-glow: rgba(16, 185, 129, 0.3);
                    --text-primary: #ffffff;
                    --text-secondary: #a0a0b0;
                    --text-muted: #6b6b7c;
                    --border-color: #2a2a3a;
                    --error-color: #ef4444;
                    --success-color: #10b981;
                    --warning-color: #f59e0b;
                    --gradient-quantum: linear-gradient(135deg, #6366f1, #8b5cf6);
                    --gradient-arp: linear-gradient(135deg, #10b981, #34d399);
                    --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
                    --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
                    --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
                    --shadow-glow-quantum: 0 0 20px var(--accent-quantum-glow);
                    --shadow-glow-arp: 0 0 20px var(--accent-arp-glow);
                }

                body {
                    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
                    background: var(--bg-primary);
                    color: var(--text-primary);
                    height: 100vh;
                    overflow: hidden;
                }

                .app {
                    display: flex;
                    flex-direction: column;
                    height: 100vh;
                    background: var(--bg-primary);
                    position: relative;
                }

                .mode-toggle {
                    padding: 16px 20px;
                    background: var(--bg-secondary);
                    border-bottom: 1px solid var(--border-color);
                    backdrop-filter: blur(10px);
                    z-index: 10;
                }

                .toggle-container {
                    display: flex;
                    gap: 8px;
                    padding: 4px;
                    background: var(--bg-tertiary);
                    border-radius: 40px;
                    max-width: 400px;
                    margin: 0 auto;
                    border: 1px solid var(--border-color);
                }

                .mode-btn {
                    flex: 1;
                    padding: 12px 20px;
                    border: none;
                    border-radius: 32px;
                    background: transparent;
                    color: var(--text-secondary);
                    font-weight: 600;
                    font-size: 14px;
                    cursor: pointer;
                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                }

                .mode-btn.quantum.active {
                    background: var(--gradient-quantum);
                    color: white;
                    box-shadow: var(--shadow-glow-quantum);
                }

                .mode-btn.arp.active {
                    background: var(--gradient-arp);
                    color: white;
                    box-shadow: var(--shadow-glow-arp);
                }

                .status-bar {
                    padding: 12px 20px;
                    background: var(--bg-secondary);
                    border-bottom: 1px solid var(--border-color);
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    font-size: 13px;
                    z-index: 5;
                }

                .status-info {
                    display: flex;
                    align-items: center;
                    gap: 12px;
                }

                .status-badge {
                    display: flex;
                    align-items: center;
                    gap: 6px;
                    padding: 4px 12px;
                    border-radius: 20px;
                    background: var(--bg-tertiary);
                    color: var(--text-secondary);
                }

                .status-dot {
                    width: 8px;
                    height: 8px;
                    border-radius: 50%;
                    transition: all 0.3s;
                }

                .status-dot.connected {
                    background: var(--success-color);
                    box-shadow: 0 0 10px var(--success-color);
                    animation: pulse 2s infinite;
                }

                .status-dot.disconnected {
                    background: var(--error-color);
                    box-shadow: 0 0 10px var(--error-color);
                }

                @keyframes pulse {
                    0%, 100% { opacity: 1; }
                    50% { opacity: 0.5; }
                }

                .experiment-badge {
                    padding: 4px 12px;
                    border-radius: 20px;
                    background: var(--accent-arp-glow);
                    color: var(--accent-arp);
                    font-family: 'Monaco', 'Menlo', monospace;
                    font-size: 12px;
                }

                .progress-bar {
                    width: 160px;
                    height: 6px;
                    background: var(--bg-tertiary);
                    border-radius: 3px;
                    overflow: hidden;
                }

                .progress-fill {
                    height: 100%;
                    background: var(--gradient-arp);
                    transition: width 0.3s ease;
                    border-radius: 3px;
                }

                .chat-container {
                    flex: 1;
                    overflow-y: auto;
                    padding: 20px;
                    scroll-behavior: smooth;
                }

                .chat-container::-webkit-scrollbar {
                    width: 6px;
                }

                .chat-container::-webkit-scrollbar-track {
                    background: var(--bg-secondary);
                }

                .chat-container::-webkit-scrollbar-thumb {
                    background: var(--border-color);
                    border-radius: 3px;
                }

                .message {
                    margin-bottom: 20px;
                    max-width: 85%;
                    animation: slideIn 0.3s ease;
                }

                @keyframes slideIn {
                    from {
                        opacity: 0;
                        transform: translateY(10px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }

                .message.user {
                    margin-left: auto;
                }

                .message.assistant {
                    margin-right: auto;
                }

                .message-bubble {
                    padding: 14px 18px;
                    border-radius: 24px;
                    font-size: 14px;
                    line-height: 1.6;
                    word-wrap: break-word;
                    white-space: pre-wrap;
                }

                .message.user .message-bubble {
                    background: var(--gradient-quantum);
                    color: white;
                    border-bottom-right-radius: 6px;
                    box-shadow: var(--shadow-md);
                }

                .message.assistant .message-bubble {
                    background: var(--bg-tertiary);
                    border: 1px solid var(--border-color);
                    border-bottom-left-radius: 6px;
                    box-shadow: var(--shadow-sm);
                }

                .message.assistant.arp .message-bubble {
                    background: rgba(16, 185, 129, 0.1);
                    border: 1px solid var(--accent-arp);
                }

                .message-meta {
                    font-size: 11px;
                    color: var(--text-muted);
                    margin-top: 6px;
                    padding: 0 8px;
                }

                .action-panel {
                    margin: 20px;
                    padding: 20px;
                    background: var(--bg-tertiary);
                    border-radius: 16px;
                    border: 1px solid var(--border-color);
                    box-shadow: var(--shadow-lg);
                    animation: slideUp 0.3s ease;
                }

                @keyframes slideUp {
                    from {
                        opacity: 0;
                        transform: translateY(20px);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0);
                    }
                }

                .action-title {
                    font-size: 14px;
                    font-weight: 600;
                    color: var(--text-primary);
                    margin-bottom: 12px;
                }

                .action-content {
                    color: var(--text-secondary);
                    font-size: 13px;
                    line-height: 1.6;
                    margin-bottom: 16px;
                    padding: 12px;
                    background: var(--bg-secondary);
                    border-radius: 12px;
                }

                .action-buttons {
                    display: flex;
                    gap: 12px;
                    flex-wrap: wrap;
                }

                .btn {
                    padding: 10px 20px;
                    border: none;
                    border-radius: 12px;
                    font-weight: 600;
                    font-size: 13px;
                    cursor: pointer;
                    transition: all 0.2s;
                    background: var(--bg-secondary);
                    color: var(--text-primary);
                    border: 1px solid var(--border-color);
                }

                .btn:hover {
                    transform: translateY(-2px);
                    box-shadow: var(--shadow-md);
                }

                .btn.primary {
                    background: var(--gradient-arp);
                    color: white;
                    border: none;
                }

                .btn.primary:hover {
                    box-shadow: var(--shadow-glow-arp);
                }

                .btn.danger {
                    background: var(--error-color);
                    color: white;
                    border: none;
                }

                .input-group {
                    margin-top: 16px;
                }

                .input-group input {
                    width: 100%;
                    padding: 12px 16px;
                    background: var(--bg-secondary);
                    border: 1px solid var(--border-color);
                    border-radius: 12px;
                    color: var(--text-primary);
                    font-size: 13px;
                }

                .input-group input:focus {
                    outline: none;
                    border-color: var(--accent-arp);
                    box-shadow: 0 0 0 3px var(--accent-arp-glow);
                }

                .input-area {
                    padding: 20px;
                    background: var(--bg-secondary);
                    border-top: 1px solid var(--border-color);
                    display: flex;
                    gap: 12px;
                    z-index: 10;
                }

                .input-wrapper {
                    flex: 1;
                }

                #messageInput {
                    width: 100%;
                    padding: 14px 20px;
                    background: var(--bg-tertiary);
                    border: 1px solid var(--border-color);
                    border-radius: 30px;
                    color: var(--text-primary);
                    font-size: 14px;
                }

                #messageInput:focus {
                    outline: none;
                    border-color: var(--accent-quantum);
                    box-shadow: 0 0 0 3px var(--accent-quantum-glow);
                }

                #messageInput.arp-mode:focus {
                    border-color: var(--accent-arp);
                    box-shadow: 0 0 0 3px var(--accent-arp-glow);
                }

                #sendButton {
                    padding: 14px 28px;
                    border: none;
                    border-radius: 30px;
                    font-weight: 600;
                    font-size: 14px;
                    cursor: pointer;
                    transition: all 0.2s;
                    background: var(--gradient-quantum);
                    color: white;
                }

                #sendButton.arp-mode {
                    background: var(--gradient-arp);
                }

                #sendButton:hover:not(:disabled) {
                    transform: translateY(-2px);
                    box-shadow: var(--shadow-glow-quantum);
                }

                #sendButton.arp-mode:hover:not(:disabled) {
                    box-shadow: var(--shadow-glow-arp);
                }

                #sendButton:disabled {
                    opacity: 0.5;
                    cursor: not-allowed;
                }

                .typing-indicator {
                    display: flex;
                    gap: 6px;
                    padding: 16px 20px;
                    background: var(--bg-tertiary);
                    border-radius: 30px;
                    width: fit-content;
                }

                .typing-dot {
                    width: 8px;
                    height: 8px;
                    border-radius: 50%;
                    background: var(--text-secondary);
                    animation: typing 1.4s infinite ease-in-out;
                }

                .typing-dot:nth-child(1) { animation-delay: 0s; }
                .typing-dot:nth-child(2) { animation-delay: 0.2s; }
                .typing-dot:nth-child(3) { animation-delay: 0.4s; }

                @keyframes typing {
                    0%, 60%, 100% { transform: translateY(0); opacity: 0.6; }
                    30% { transform: translateY(-8px); opacity: 1; }
                }

                .welcome-screen {
                    text-align: center;
                    padding: 40px 20px;
                    color: var(--text-secondary);
                }

                .welcome-title {
                    font-size: 24px;
                    font-weight: 700;
                    margin-bottom: 16px;
                    background: var(--gradient-quantum);
                    -webkit-background-clip: text;
                    -webkit-text-fill-color: transparent;
                }

                .error-message {
                    background: rgba(239, 68, 68, 0.1);
                    border: 1px solid var(--error-color);
                    color: var(--error-color);
                    padding: 12px 16px;
                    border-radius: 12px;
                    margin: 10px 20px;
                    font-size: 13px;
                }

                .hidden {
                    display: none !important;
                }
            </style>
        </head>
        <body>
            <div class="app">
                <div class="mode-toggle">
                    <div class="toggle-container">
                        <button class="mode-btn quantum active" data-mode="quantum">üî¨ QuantumBot</button>
                        <button class="mode-btn arp" data-mode="arp">ü§ñ ARP Research</button>
                    </div>
                </div>

                <div class="status-bar">
                    <div class="status-info">
                        <span id="modeIndicator" class="status-badge">
                            <span class="status-dot connected"></span>
                            <span>Quantum Mode</span>
                        </span>
                        <span id="experimentBadge" class="experiment-badge hidden"></span>
                    </div>
                    <div id="progressContainer" class="progress-bar hidden">
                        <div class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>

                <div class="chat-container" id="chatContainer">
                    <div class="welcome-screen" id="welcomeScreen">
                        <div class="welcome-title">Welcome to Quantum AI</div>
                        <div class="welcome-subtitle">
                            Select a mode to begin. QuantumBot for quantum code assistance, 
                            or ARP Research for autonomous research workflows.
                        </div>
                    </div>
                </div>

                <div id="actionPanel" class="action-panel hidden">
                    <div class="action-title" id="actionTitle"></div>
                    <div class="action-content" id="actionContent"></div>
                    <div class="action-buttons" id="actionButtons"></div>
                    <div class="input-group hidden" id="actionInput">
                        <input type="text" id="actionInputField" placeholder="Enter your response..." />
                    </div>
                </div>

                <div class="input-area">
                    <div class="input-wrapper">
                        <input type="text" id="messageInput" placeholder="Type your message..." />
                    </div>
                    <button id="sendButton">Send</button>
                </div>
            </div>

            <script>
                (function() {
                    const vscode = acquireVsCodeApi();
                    
                    // DOM Elements
                    const chatContainer = document.getElementById('chatContainer');
                    const welcomeScreen = document.getElementById('welcomeScreen');
                    const messageInput = document.getElementById('messageInput');
                    const sendButton = document.getElementById('sendButton');
                    const modeButtons = document.querySelectorAll('.mode-btn');
                    const modeIndicator = document.getElementById('modeIndicator');
                    const experimentBadge = document.getElementById('experimentBadge');
                    const progressContainer = document.getElementById('progressContainer');
                    const progressFill = document.querySelector('.progress-fill');
                    const actionPanel = document.getElementById('actionPanel');
                    const actionTitle = document.getElementById('actionTitle');
                    const actionContent = document.getElementById('actionContent');
                    const actionButtons = document.getElementById('actionButtons');
                    const actionInput = document.getElementById('actionInput');
                    const actionInputField = document.getElementById('actionInputField');

                    // State
                    let currentMode = 'quantum';
                    let isWaiting = false;
                    let currentArpState = null;

                    // Mode Switching
                    modeButtons.forEach(btn => {
                        btn.addEventListener('click', () => {
                            const mode = btn.dataset.mode;
                            if (mode === currentMode) return;

                            modeButtons.forEach(b => b.classList.remove('active'));
                            btn.classList.add('active');
                            currentMode = mode;

                            // Update UI
                            updateModeUI();
                            
                            // Send mode switch to extension
                            vscode.postMessage({
                                command: 'switchMode',
                                mode: currentMode
                            });
                        });
                    });

                    function updateModeUI() {
                        const dot = modeIndicator.querySelector('.status-dot');
                        const text = modeIndicator.querySelector('span:last-child');
                        
                        if (currentMode === 'quantum') {
                            text.textContent = 'Quantum Mode';
                            messageInput.classList.remove('arp-mode');
                            sendButton.classList.remove('arp-mode');
                        } else {
                            text.textContent = 'ARP Mode';
                            messageInput.classList.add('arp-mode');
                            sendButton.classList.add('arp-mode');
                        }

                        // Hide ARP-specific UI in quantum mode
                        if (currentMode === 'quantum') {
                            experimentBadge.classList.add('hidden');
                            progressContainer.classList.add('hidden');
                            actionPanel.classList.add('hidden');
                        } else if (currentArpState) {
                            if (currentArpState.experimentId) {
                                experimentBadge.classList.remove('hidden');
                                experimentBadge.textContent = \`Exp: \${currentArpState.experimentId.slice(0, 8)}\`;
                            }
                            if (currentArpState.progressPct > 0) {
                                progressContainer.classList.remove('hidden');
                                progressFill.style.width = currentArpState.progressPct + '%';
                            }
                            if (currentArpState.pendingQuestion || currentArpState.pendingAction) {
                                showActionPanel(currentArpState);
                            }
                        }
                    }

                    // Send Message
                    sendButton.addEventListener('click', sendMessage);
                    messageInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            sendMessage();
                        }
                    });

                    function sendMessage() {
                        const text = messageInput.value.trim();
                        if (!text || isWaiting) return;

                        // Add user message
                        addMessage('user', text);
                        messageInput.value = '';

                        // Show typing indicator
                        showTypingIndicator();
                        isWaiting = true;

                        // Send to extension
                        vscode.postMessage({
                            command: 'sendMessage',
                            text: text
                        });
                    }

                    function addMessage(role, content, isArp = false) {
                        welcomeScreen.classList.add('hidden');

                        const messageDiv = document.createElement('div');
                        messageDiv.className = \`message \${role}\`;
                        
                        if (isArp && role === 'assistant') {
                            messageDiv.classList.add('arp');
                        }

                        // Handle markdown content
                        let displayContent = content;
                        try {
                            displayContent = marked.parse(content);
                        } catch {
                            // If marked fails, use plain text
                            displayContent = content.replace(/\\n/g, '<br>');
                        }

                        messageDiv.innerHTML = \`
                            <div class="message-bubble">\${displayContent}</div>
                            <div class="message-meta">\${role === 'user' ? 'You' : (currentMode === 'quantum' ? 'QuantumBot' : 'ARP')}</div>
                        \`;

                        chatContainer.appendChild(messageDiv);
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }

                    function showTypingIndicator() {
                        hideTypingIndicator();
                        
                        const indicator = document.createElement('div');
                        indicator.className = 'message assistant';
                        indicator.id = 'typingIndicator';
                        indicator.innerHTML = \`
                            <div class="typing-indicator">
                                <span class="typing-dot"></span>
                                <span class="typing-dot"></span>
                                <span class="typing-dot"></span>
                            </div>
                        \`;
                        chatContainer.appendChild(indicator);
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }

                    function hideTypingIndicator() {
                        const indicator = document.getElementById('typingIndicator');
                        if (indicator) indicator.remove();
                        isWaiting = false;
                    }

                    function showError(message) {
                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'error-message';
                        errorDiv.textContent = message;
                        chatContainer.appendChild(errorDiv);
                        chatContainer.scrollTop = chatContainer.scrollHeight;
                    }

                    function showActionPanel(state) {
                        actionPanel.classList.remove('hidden');

                        if (state.pendingQuestion) {
                            actionTitle.textContent = '‚ùì Clarification Needed';
                            actionContent.textContent = state.pendingQuestion.text;
                            
                            let buttons = \`
                                <button class="btn primary" onclick="acceptQuestion()">Accept Suggested</button>
                                <button class="btn" onclick="showCustomAnswer()">Custom Answer</button>
                            \`;
                            
                            if (state.pendingQuestion.options) {
                                const optionsText = state.pendingQuestion.options.join(', ');
                                actionContent.innerHTML += \`<br><small>Options: \${optionsText}</small>\`;
                            }

                            actionButtons.innerHTML = buttons;
                            actionInput.classList.add('hidden');
                            
                        } else if (state.pendingAction) {
                            actionTitle.textContent = 'ü§î Action Required';
                            actionContent.textContent = state.pendingAction.action;
                            
                            if (state.pendingAction.reason) {
                                actionContent.innerHTML += \`<br><small>Reason: \${state.pendingAction.reason}</small>\`;
                            }

                            actionButtons.innerHTML = \`
                                <button class="btn primary" onclick="acceptAction()">Accept & Execute</button>
                                <button class="btn danger" onclick="showDenyReason()">Deny</button>
                            \`;
                            
                            actionInput.classList.add('hidden');
                        }
                    }

                    // Action Handlers
                    window.acceptQuestion = () => {
                        vscode.postMessage({ command: 'acceptQuestion' });
                        actionPanel.classList.add('hidden');
                    };

                    window.showCustomAnswer = () => {
                        actionButtons.innerHTML = '';
                        actionInput.classList.remove('hidden');
                        actionInputField.placeholder = 'Enter your custom answer...';
                        
                        const submitBtn = document.createElement('button');
                        submitBtn.className = 'btn primary';
                        submitBtn.textContent = 'Submit Answer';
                        submitBtn.onclick = () => {
                            const answer = actionInputField.value.trim();
                            if (answer) {
                                vscode.postMessage({
                                    command: 'denyQuestion',
                                    value: answer
                                });
                                actionPanel.classList.add('hidden');
                                actionInputField.value = '';
                            }
                        };
                        actionButtons.appendChild(submitBtn);
                        
                        const cancelBtn = document.createElement('button');
                        cancelBtn.className = 'btn';
                        cancelBtn.textContent = 'Cancel';
                        cancelBtn.onclick = () => {
                            actionInput.classList.add('hidden');
                            showActionPanel(currentArpState);
                        };
                        actionButtons.appendChild(cancelBtn);
                    };

                    window.acceptAction = () => {
                        vscode.postMessage({ command: 'acceptConfirm' });
                        actionPanel.classList.add('hidden');
                    };

                    window.showDenyReason = () => {
                        actionButtons.innerHTML = '';
                        actionInput.classList.remove('hidden');
                        actionInputField.placeholder = 'Reason for denial...';
                        
                        const submitBtn = document.createElement('button');
                        submitBtn.className = 'btn danger';
                        submitBtn.textContent = 'Submit Denial';
                        submitBtn.onclick = () => {
                            const reason = actionInputField.value.trim();
                            vscode.postMessage({
                                command: 'denyConfirm',
                                reason: reason
                            });
                            actionPanel.classList.add('hidden');
                            actionInputField.value = '';
                        };
                        actionButtons.appendChild(submitBtn);
                        
                        const cancelBtn = document.createElement('button');
                        cancelBtn.className = 'btn';
                        cancelBtn.textContent = 'Cancel';
                        cancelBtn.onclick = () => {
                            actionInput.classList.add('hidden');
                            showActionPanel(currentArpState);
                        };
                        actionButtons.appendChild(cancelBtn);
                    };

                    // Handle messages from extension
                    window.addEventListener('message', event => {
                        const message = event.data;

                        switch (message.command) {
                            case 'quantumReply':
                                hideTypingIndicator();
                                addMessage('assistant', message.text, false);
                                break;

                            case 'userMessage':
                                addMessage('user', message.text);
                                break;

                            case 'arpMessage':
                                hideTypingIndicator();
                                addMessage('assistant', message.message.content, true);
                                break;

                            case 'arpState':
                                currentArpState = message.state;
                                if (currentMode === 'arp') {
                                    if (message.state.experimentId) {
                                        experimentBadge.classList.remove('hidden');
                                        experimentBadge.textContent = \`Exp: \${message.state.experimentId.slice(0, 8)}\`;
                                    } else {
                                        experimentBadge.classList.add('hidden');
                                    }
                                    
                                    if (message.state.progressPct > 0) {
                                        progressContainer.classList.remove('hidden');
                                        progressFill.style.width = message.state.progressPct + '%';
                                    } else {
                                        progressContainer.classList.add('hidden');
                                    }
                                    
                                    if (message.state.pendingQuestion || message.state.pendingAction) {
                                        showActionPanel(message.state);
                                    } else {
                                        actionPanel.classList.add('hidden');
                                    }
                                }
                                break;

                            case 'backendStatus':
                                const dot = modeIndicator.querySelector('.status-dot');
                                if (currentMode === 'quantum') {
                                    dot.className = 'status-dot ' + (message.quantum ? 'connected' : 'disconnected');
                                } else {
                                    dot.className = 'status-dot ' + (message.arp ? 'connected' : 'disconnected');
                                }
                                break;

                            case 'error':
                                hideTypingIndicator();
                                showError(message.text);
                                break;

                            case 'modeSwitched':
                                hideTypingIndicator();
                                break;

                            case 'showLoading':
                                showTypingIndicator();
                                break;

                            case 'hideLoading':
                                hideTypingIndicator();
                                break;

                            case 'clearChat':
                                chatContainer.innerHTML = '';
                                welcomeScreen.classList.remove('hidden');
                                break;
                        }
                    });

                    // Check backend health on load
                    vscode.postMessage({ command: 'checkBackend' });
                })();
            </script>
        </body>
        </html>`;
    }
}